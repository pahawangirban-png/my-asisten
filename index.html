<!DOCTYPE html>
<html lang="id">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
	<title>AI ASISTEN</title>
	
	<!-- Tailwind CSS -->
	<script src="https://cdn.tailwindcss.com"></script>
	
	<!-- FontAwesome Icons -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>
	<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
	
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="theme-color" content="#ffffff">
	<meta name="apple-mobile-web-app-title" content="AI ASISTEN">
	<link rel="apple-touch-icon" href="icon/icon-512.png">
	<link rel="icon" type="image/png" href="icon/icon-512.png">
	
	<!-- Marked.js (VERSI 4.3.0 - STABIL) -->
	<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
	
	<!-- Highlight.js (StackOverflow Light) -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/stackoverflow-light.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
	
	<style>
		::-webkit-scrollbar {
			width: 8px;
			height: 8px;
		}
		
		::-webkit-scrollbar-track {
			background: #ffffff;
		}
		
		::-webkit-scrollbar-thumb {
			background: #cbd5e1;
			border-radius: 4px;
		}
		
		::-webkit-scrollbar-thumb:hover {
			background: #94a3b8;
		}
		
		html {
			height: 100%;
			overflow: hidden;
			overscroll-behavior: none;
		}
		
		body {
			height: 100dvh;
			width: 100%;
			overflow: hidden;
			position: fixed;
			overscroll-behavior: none;
			touch-action: none;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}
		
		#chat-container {
			touch-action: pan-y; 
			-webkit-overflow-scrolling: touch;
		}
		
		button,
		input,
		textarea {
			touch-action: manipulation;
			-webkit-text-size-adjust: 100%;
		}
		
		.prose p {
			margin-bottom: 0.6em;
			line-height: 1.6;
			font-weight: 400 !important;
			color: #374151 !important;
		}
		
		.prose p:last-child {
			margin-bottom: 0;
		}
		
		.prose strong,
		.prose b {
			font-weight: 600;
			color: #111827;
		}
		
		.prose pre {
			margin: 0;
			padding: 0;
			background-color: transparent;
			border: none;
			overflow: visible;
		}
		
		.prose p code,
		.prose li code,
		.prose td code {
			background-color: rgba(0, 0, 0, 0.06);
			padding: 0.15em 0.4em;
			border-radius: 0.25em;
			font-size: 0.9em;
			font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
			color: #be185d;
		}
		
		.prose pre code {
			display: block;
			font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
			font-size: 14px;
			line-height: 1.6;
		}
		
		.prose ul,
		.prose ol {
			padding-left: 1em;
			margin-left: 0.5em;
			margin-bottom: 0.8em;
			color: #374151;
		}
		
		.prose ul {
			list-style-type: disc;
		}
		
		.prose ol {
			list-style-type: decimal;
		}
		
		.prose li {
			margin-bottom: 0.25em;
		}
		
		.prose h1,
		.prose h2,
		.prose h3 {
			font-weight: 700;
			margin-top: 1em;
			margin-bottom: 0.5em;
			color: #111827;
		}
		
		.prose h1 {
			font-size: 1.5em;
		}
		
		.prose h2 {
			font-size: 1.25em;
		}
		
		.prose h3 {
			font-size: 1.1em;
		}
		
		.prose table {
			width: 100%;
			border-collapse: collapse;
			margin: 0;
			font-size: 0.9em;
			border: 1px solid #d1d5db;
		}
		
		.prose thead {
			background-color: #e5e7eb;
		}
		
		.prose th,
		.prose td {
			border: 1px solid #d1d5db;
			padding: 0.75rem;
			text-align: left;
			vertical-align: top;
			color: #374151;
		}
		
		.prose th {
			font-weight: 600;
			color: #1f2937;
		}
		
		.typing-dot {
			animation: typing 1.4s infinite ease-in-out both;
		}
		
		.typing-dot:nth-child(1) {
			animation-delay: -0.32s;
		}
		
		.typing-dot:nth-child(2) {
			animation-delay: -0.16s;
		}
		
		@keyframes typing {
			0%,
			80%,
			100% {
				transform: scale(0);
			}
			40% {
				transform: scale(1);
			}
		}
		/* Animasi Alert iOS */
		@keyframes alert-pop {
			0% { transform: scale(1.1); opacity: 0; }
			100% { transform: scale(1); opacity: 1; }
		}
		.animate-alert {
			animation: alert-pop 0.2s cubic-bezier(0.1, 0.9, 0.2, 1) forwards;
		}
	</style>
</head>

<body class="bg-white w-full font-sans text-gray-800">
	
	<!-- Header -->
	<header class="fixed top-0 left-0 w-full bg-white/90 backdrop-blur-sm shadow-sm p-4 flex justify-between items-center z-50 h-20">
		<div class="w-full flex justify-between items-center">
			<div class="flex items-center gap-0">
				<img src="icon/icon.png" alt="icon" class="w-16 h-16 rounded-full object-cover -mt-1">
				
				<div class="flex flex-col justify-center h-16">
					<h1 class="font-semibold text-xl leading-none bg-gradient-to-r from-blue-600 to-cyan-400 bg-clip-text text-transparent">AI ASISTEN</h1>
					<p class="text-[10px] font-bold tracking-wider text-gray-400 mt-1">ARTIFICIAL INTELLIGENCE</p>
				</div>
			</div>
			
			<button onclick="resetKey()" id="reset-btn" class="hidden text-gray-400 transition p-2" title="Mulai Ulang (Reset)">
				<svg class="w-7 h-7 fill-current" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
					<path d="M12 16c1.671 0 3-1.331 3-3s-1.329-3-3-3-3 1.331-3 3 1.329 3 3 3z"></path>
					<path d="M20.817 11.186a8.94 8.94 0 0 0-1.355-3.219 9.053 9.053 0 0 0-2.43-2.43 8.95 8.95 0 0 0-3.219-1.355 9.028 9.028 0 0 0-1.838-.18V2L8 5l3.975 3V6.002c.484-.002.968.044 1.435.14a6.961 6.961 0 0 1 2.502 1.053 7.005 7.005 0 0 1 1.892 1.892A6.967 6.967 0 0 1 19 13a7.032 7.032 0 0 1-.55 2.725 7.11 7.11 0 0 1-.644 1.188 7.2 7.2 0 0 1-.858 1.039 7.028 7.028 0 0 1-3.536 1.907 7.13 7.13 0 0 1-2.822 0 6.961 6.961 0 0 1-2.503-1.054 7.002 7.002 0 0 1-1.89-1.89A6.996 6.996 0 0 1 5 13H3a9.02 9.02 0 0 0 1.539 5.034 9.096 9.096 0 0 0 2.428 2.428A8.95 8.95 0 0 0 12 22a9.09 9.09 0 0 0 1.814-.183 9.014 9.014 0 0 0 3.218-1.355 8.886 8.886 0 0 0 1.331-1.099 9.228 9.228 0 0 0 1.1-1.332A8.952 8.952 0 0 0 21 13a9.09 9.09 0 0 0-.183-1.814z"></path>
				</svg>
			</button>
		</div>
	</header>
	
	<!-- Chat Area -->
	<main id="chat-container" class="fixed top-20 bottom-0 left-0 w-full overflow-y-auto pt-4 pb-32 px-4 space-y-6 bg-white">
		<!-- Chat items will be injected here -->
	</main>
	
	<!-- Input Area -->
	<footer class="fixed bottom-0 left-0 w-full bg-white z-50">
		<div class="w-full px-4 py-6 bg-white">
			<div class="max-w-3xl mx-auto flex flex-col">
				
				<div id="file-preview-container" class="hidden w-full mb-2">
					<div id="file-list" class="grid grid-cols-2 md:grid-cols-4 gap-2"></div>
				</div>

				<div class="flex items-center gap-0 bg-gray-100 pr-2 pl-2 rounded-full h-[58px] w-full z-20">
					<input type="file" id="file-upload" class="hidden" accept=".html,.css,.js,.txt,.swift,.pdf,.docx,.xlsx,.xls,image/*" multiple onchange="handleFileSelect(event)">
					
					<button onclick="document.getElementById('file-upload').click()" class="flex-shrink-0 w-10 h-10 flex items-center justify-center text-gray-400 transition" title="Upload File">
						<i class="fa-solid fa-plus text-xl"></i>
					</button>
					
					<input type="text" id="user-input" placeholder="Ketik pesan..." class="w-full bg-transparent text-gray-800 focus:outline-none text-base h-full pl-1" autocomplete="off" onkeydown="handleEnter(event)">
					
					<button onclick="handleInput()" id="action-btn" class="flex-shrink-0 bg-black hover:bg-gray-800 text-white rounded-full w-10 h-10 flex items-center justify-center transition disabled:opacity-50 disabled:cursor-not-allowed">
						<i id="action-icon" class="fa-solid fa-arrow-right text-xl"></i>
					</button>
				</div>
				
			</div>
		</div>
	</footer>
	<div id="custom-alert" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/40 backdrop-blur-[2px] transition-opacity duration-200">
		<div class="bg-white/95 w-[270px] rounded-2xl text-center shadow-2xl animate-alert backdrop-blur-xl overflow-hidden transform scale-100">
			<div class="pt-5 pb-2 px-4">
				<h3 class="text-base font-bold text-gray-900 leading-snug mb-1">Reset Asisten?</h3>
				<p class="text-sm text-gray-600 leading-relaxed">
					Semua riwayat percakapan dan API Key akan dihapus dari perangkat ini.
				</p>
			</div>
			<div class="flex border-t border-gray-300/70">
				<button onclick="closeCustomAlert()" class="w-1/2 py-3 text-base text-blue-500 hover:bg-gray-100 active:bg-gray-200 transition font-normal border-r border-gray-300/70">
					BATAL
				</button>
				<button onclick="confirmReset()" class="w-1/2 py-3 text-base text-red-500 font-normal hover:bg-gray-100 active:bg-gray-200 transition">
					HAPUS
				</button>
			</div>
		</div>
	</div>
	<script>
		document.addEventListener('gesturestart', function(e) {
			e.preventDefault();
		});
		
		let lastTouchEnd = 0;
		document.addEventListener('touchend', function(event) {
			const now = (new Date()).getTime();
			if (now - lastTouchEnd <= 300) {
				event.preventDefault();
			}
			lastTouchEnd = now;
		}, { passive: false });

		document.body.addEventListener('touchmove', function(e) {
			if (!e.target.closest('#chat-container')) {
				e.preventDefault();
			}
		}, { passive: false });
		
		let isMarkedAvailable = false;
		try {
			if (typeof marked !== 'undefined') {
				const renderer = new marked.Renderer();
				
				renderer.code = function(code, language) {
					let highlighted = code;
					if (language && typeof hljs !== 'undefined' && hljs.getLanguage(language)) {
						highlighted = hljs.highlight(code, { language: language }).value;
					} else if (typeof hljs !== 'undefined') {
						try { highlighted = hljs.highlightAuto(code).value; } catch (e) {}
					}
					const langDisplay = (language || 'text').toUpperCase();
					return `
                    <div class="code-wrapper my-5 rounded-lg overflow-hidden bg-gray-200 shadow-sm">
                        <div class="flex justify-between items-center px-4 py-2 bg-gray-200 border-b-2 border-gray-100">
                            <span class="text-xs font-bold text-gray-600 font-sans tracking-tight">${langDisplay}</span>
                            <button onclick="copyCode(this)" class="text-gray-500 hover:text-gray-800 transition flex items-center justify-center w-5 h-5" title="Salin Kode">
                                <i class="fa-regular fa-clipboard text-sm"></i>
                            </button>
                        </div>
                        <pre class="!m-0 !p-0 !border-0 !rounded-none overflow-x-auto bg-gray-200"><code class="hljs language-${language} !p-4 block !bg-gray-200">${highlighted}</code></pre>
                    </div>`;
				};
				
				renderer.table = function(header, body) {
					return `<div class="my-4 w-full overflow-x-auto"><table><thead>${header}</thead><tbody>${body}</tbody></table></div>`;
				};
				
				marked.use({ renderer: renderer, gfm: true, breaks: true });
				isMarkedAvailable = true;
			}
		} catch (e) {
			console.error(e);
		}
		
		function copyCode(btn) {
			const wrapper = btn.closest('.code-wrapper');
			const codeBlock = wrapper.querySelector('code');
			const text = codeBlock.innerText;
			navigator.clipboard.writeText(text).then(() => {
				const icon = btn.querySelector('i');
				icon.className = 'fa-solid fa-check text-green-600 text-sm';
				setTimeout(() => { icon.className = 'fa-regular fa-clipboard text-sm'; }, 2000);
			}).catch(err => {});
		}
		
		let chatHistory = [];
		let isGenerating = false;
		let abortController = null;
		let selectedFiles = [];
		
		const chatContainer = document.getElementById('chat-container');
		const userInput = document.getElementById('user-input');
		const actionBtn = document.getElementById('action-btn');
		const actionIcon = document.getElementById('action-icon');
		const resetBtn = document.getElementById('reset-btn');
		const filePreviewContainer = document.getElementById('file-preview-container');
		const fileList = document.getElementById('file-list');
		const fileInput = document.getElementById('file-upload');
		
		document.addEventListener('DOMContentLoaded', () => {
			const savedKey = localStorage.getItem('gemini_api_key');
			const savedHistory = localStorage.getItem('gemini_chat_history');
			
			if (savedKey) {
				resetBtn.classList.remove('hidden');
				if (savedHistory) {
					try {
						chatHistory = JSON.parse(savedHistory);
						chatHistory.forEach(msg => {
							addMessageToUI(msg.role, msg.parts[0].text, false, msg.files || []);
						});
					} catch (e) {
						localStorage.removeItem('gemini_chat_history');
					}
				} else {
					const welcomeMsg = "Halo! ASISTEN siap membantu, ada yang bisa saya kerjakan hari ini?";
					addMessageToUI('model', welcomeMsg, false);
					chatHistory.push({ role: "model", parts: [{ text: welcomeMsg }] });
					saveChatHistory();
				}
			} else {
				userInput.placeholder = "Tempel API Key Google Gemini Anda di sini...";
			}
			if (window.visualViewport) {
				let lastHeight = window.visualViewport.height;
				window.visualViewport.addEventListener('resize', () => {
					// Jika tinggi viewport bertambah (artinya keyboard turun/tutup)
					if (window.visualViewport.height > lastHeight) {
						setTimeout(() => {
							window.scrollTo(0, 0);
							// Scroll chat ke paling bawah
							chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
						}, 50);
					}
					lastHeight = window.visualViewport.height;
				});
			}
		});
		
		function getFileType(filename) {
			if (!filename) return 'FILE';
			const ext = filename.split('.').pop().toLowerCase();
			if (['jpg', 'jpeg', 'png', 'webp', 'heic'].includes(ext)) return 'IMG';
			if (ext === 'docx') return 'WORD';
			if (['xls', 'xlsx'].includes(ext)) return 'EXCEL';
			if (ext === 'pdf') return 'PDF';
			return ext.toUpperCase();
		}

		function formatFileSize(bytes) {
			if (bytes === 0) return '0 B';
			const k = 1024;
			const sizes = ['B', 'KB', 'MB', 'GB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
		}

		async function fileToText(file) {
			const ext = file.name.split('.').pop().toLowerCase();
			if (ext === 'docx') {
				const arrayBuffer = await file.arrayBuffer();
				const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
				return result.value;
			}
			if (['xlsx', 'xls'].includes(ext)) {
				const arrayBuffer = await file.arrayBuffer();
				const workbook = XLSX.read(arrayBuffer, { type: 'array' });
				let text = "";
				workbook.SheetNames.forEach(sheetName => {
					const sheet = workbook.Sheets[sheetName];
					text += `\n--- Sheet: ${sheetName} ---\n`;
					text += XLSX.utils.sheet_to_csv(sheet);
				});
				return text;
			}
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onload = (e) => resolve(e.target.result);
				reader.onerror = reject;
				reader.readAsText(file);
			});
		}

		async function fileToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.onload = (e) => {
					const base64Data = e.target.result.split(',')[1];
					resolve({
						inlineData: {
							mimeType: file.type,
							data: base64Data
						}
					});
				};
				reader.onerror = reject;
				reader.readAsDataURL(file);
			});
		}

		async function processFiles(files) {
			const textFiles = [];
			const mediaParts = [];
			for (const file of files) {
				const ext = file.name.split('.').pop().toLowerCase();
				if (['html', 'css', 'js', 'txt', 'swift', 'docx', 'xlsx', 'xls'].includes(ext)) {
					try {
						const content = await fileToText(file);
						textFiles.push(`\n=== File: ${file.name} ===\n${content}\n=== End File ===\n`);
					} catch (e) {
						console.error(e);
					}
				} 
				else if (['pdf', 'jpg', 'jpeg', 'png', 'webp', 'heic'].includes(ext) || file.type.startsWith('image/')) {
					try {
						const base64Part = await fileToBase64(file);
						mediaParts.push(base64Part);
					} catch (e) {
						console.error(e);
					}
				}
			}
			return { textContext: textFiles.join('\n'), mediaParts };
		}

		function renderFilePreviews() {
			fileList.innerHTML = '';
			if (selectedFiles.length > 0) {
				filePreviewContainer.classList.remove('hidden');
				selectedFiles.forEach((file, index) => {
					const ext = file.name.split('.').pop().toLowerCase();
					let type = ext;
					if (['xlsx', 'xls'].includes(ext)) type = 'excel';
					if (['docx', 'doc'].includes(ext)) type = 'word';
					
					const iconSrc = `icon/${type}-file-icon.svg`;

					const card = document.createElement('div');
					card.className = 'relative bg-gray-100 rounded-xl p-3 flex items-center gap-3 group border border-transparent hover:border-gray-200 transition-all';
					card.innerHTML = `
                        <div class="flex-shrink-0 flex items-center justify-center">
                            <img src="${iconSrc}" alt="${type}" class="w-8 h-8 object-contain" onerror="this.src='https://placehold.co/32?text=FILE'">
                        </div>
                        <div class="flex-1 min-w-0 flex flex-col justify-center">
                            <p class="text-sm font-medium text-gray-800 truncate leading-tight" title="${file.name}">${file.name}</p>
                            <p class="text-[10px] text-gray-500 mt-0.5 font-medium">${formatFileSize(file.size)}</p>
                        </div>
                        <button onclick="removeFile(${index})" class="absolute -top-3 -right-3 p-1 text-gray-400 hover:text-red-500 transition-colors z-20" title="Hapus File">
                            <svg class="w-5 h-5 fill-current drop-shadow-sm" viewBox="0 0 122.881 122.88"><g><path fill-rule="evenodd" clip-rule="evenodd" d="M61.44,0c33.933,0,61.441,27.507,61.441,61.439 c0,33.933-27.508,61.44-61.441,61.44C27.508,122.88,0,95.372,0,61.439C0,27.507,27.508,0,61.44,0L61.44,0z M81.719,36.226 c1.363-1.363,3.572-1.363,4.936,0c1.363,1.363,1.363,3.573,0,4.936L66.375,61.439l20.279,20.278c1.363,1.363,1.363,3.573,0,4.937 c-1.363,1.362-3.572,1.362-4.936,0L61.44,66.376L41.162,86.654c-1.362,1.362-3.573,1.362-4.936,0c-1.363-1.363-1.363-3.573,0-4.937 l20.278-20.278L36.226,41.162c-1.363-1.363-1.363-3.573,0-4.936c1.363-1.363,3.573-1.363,4.936,0L61.44,56.504L81.719,36.226 L81.719,36.226z"/></g></svg>
                        </button>`;
					fileList.appendChild(card);
				});
			} else {
				filePreviewContainer.classList.add('hidden');
			}
		}

		function generateFileGridHtml(files) {
			if (!files || files.length === 0) return '';
			let html = '<div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-3 mb-2">';
			files.forEach(file => {
				const ext = file.name.split('.').pop().toLowerCase();
				let type = ext;
				if (['xlsx', 'xls'].includes(ext)) type = 'excel';
				if (['docx', 'doc'].includes(ext)) type = 'word';
				
				const iconSrc = `icon/${type}-file-icon.svg`;
				
				html += `
                    <div class="relative bg-gray-200 rounded-xl p-3 flex items-center gap-3 border border-transparent overflow-hidden">
                        <div class="flex-shrink-0 flex items-center justify-center">
                            <img src="${iconSrc}" alt="${type}" class="w-8 h-8 object-contain" onerror="this.src='https://placehold.co/32?text=FILE'">
                        </div>
                        <div class="flex-1 min-w-0 flex flex-col justify-center">
                            <p class="text-sm font-medium text-gray-800 truncate leading-tight" title="${file.name}">
                                ${file.name}
                            </p>
                            <p class="text-[10px] text-gray-500 mt-0.5 font-medium">
                                ${formatFileSize(file.size)}
                            </p>
                        </div>
                    </div>`;
			});
			html += '</div>';
			return html;
		}

		async function sendMessage(text, apiKey) {
			const rawFiles = [...selectedFiles];
			const filesToSend = selectedFiles.map(f => ({ name: f.name, size: f.size, type: f.type }));
			
			userInput.value = '';
			selectedFiles = [];
			renderFilePreviews();
			
			addMessageToUI('user', text, false, filesToSend);
			
			updateUIState(true);
			showLoadingPlaceholder();
			
			abortController = new AbortController();
			let fullText = "";
			let collectedMetadata = null;
			
			try {
				const { textContext, mediaParts } = await processFiles(rawFiles);
				
				const finalUserTextForAPI = text + (textContext ? `\n\n[USER UPLOADED DOCUMENTS CONTENT]:\n${textContext}` : "");
				
				const apiCurrentTurnParts = [...mediaParts, { text: finalUserTextForAPI }];
				
				const apiContents = chatHistory.map(msg => ({ role: msg.role, parts: msg.parts }));
				apiContents.push({ role: "user", parts: apiCurrentTurnParts });
				
				const historyMsg = { role: "user", parts: [{ text: text }], files: filesToSend };
				chatHistory.push(historyMsg);
				saveChatHistory();
				
				const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:streamGenerateContent?key=${apiKey}`;
				
				const response = await fetch(url, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						contents: apiContents,
						systemInstruction: { parts: [{ text: "Kamu adalah Aura, Asisten Pribadi Kak Nixon yang cerdas, ramah, dan profesional. WAJIB: Gunakan Google Search untuk memverifikasi semua informasi faktual." }] },
						tools: [{ google_search: {} }],
						generationConfig: { temperature: 0.5, maxOutputTokens: 8192 }
					}),
					signal: abortController.signal
				});
				
				removeLoading();
				if (!response.ok) throw new Error((await response.json()).error?.message || 'API Error');
				
				const msgId = addMessageToUI('model', '', true);
				const msgEl = document.getElementById(msgId);
				const reader = response.body.getReader();
				const decoder = new TextDecoder();
				let buffer = '';
				
				while (true) {
					const { done, value } = await reader.read();
					if (done) break;
					buffer += decoder.decode(value, { stream: true });
					
					let braceCount = 0,
						startIndex = -1,
						inString = false,
						isEscaped = false;
					for (let i = 0; i < buffer.length; i++) {
						const char = buffer[i];
						if (isEscaped) { isEscaped = false; continue; }
						if (char === '\\') { isEscaped = true; continue; }
						if (char === '"') { inString = !inString; continue; }
						if (!inString) {
							if (char === '{') {
								if (braceCount === 0) startIndex = i;
								braceCount++;
							} else if (char === '}') {
								braceCount--;
								if (braceCount === 0 && startIndex !== -1) {
									const jsonStr = buffer.substring(startIndex, i + 1);
									try {
										const data = JSON.parse(jsonStr);
										if (data.candidates?.[0]?.groundingMetadata) collectedMetadata = data.candidates[0].groundingMetadata;
										const newText = data.candidates?.[0]?.content?.parts?.[0]?.text;
										if (newText) {
											fullText += newText;
											msgEl.innerHTML = isMarkedAvailable ? marked.parse(fullText) : `<p class="whitespace-pre-wrap">${fullText}</p>`;
											chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'auto' });
										}
									} catch (e) {}
									buffer = buffer.substring(i + 1);
									i = -1;
									startIndex = -1;
								}
							}
						}
					}
				}
				
				chatHistory.push({ role: "model", parts: [{ text: fullText }] });
				saveChatHistory();
				if (collectedMetadata) {
					renderGroundingSources(msgId, collectedMetadata);
					setTimeout(() => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }), 100);
				}
				
			} catch (error) {
				if (error.name !== 'AbortError') {
					removeLoading();
					const errDiv = document.createElement('div');
					errDiv.className = 'w-full max-w-3xl mx-auto mb-6';
					errDiv.innerHTML = `<div class="bg-red-50 text-red-600 px-4 py-3 rounded-xl text-sm border border-red-100 flex items-center gap-2"><i class="fa-solid fa-circle-exclamation"></i><span>Error: ${error.message}</span></div>`;
					chatContainer.appendChild(errDiv);
				} else {
					removeLoading();
					if (fullText) { chatHistory.push({ role: "model", parts: [{ text: fullText }] });
						saveChatHistory(); }
				}
			} finally {
				updateUIState(false);
				abortController = null;
			}
		}
		
		function handleFileSelect(event) {
			const files = Array.from(event.target.files);
			files.forEach(file => {
				const name = file.name.toLowerCase();
				if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
					selectedFiles.push(file);
				}
			});
			renderFilePreviews();
			fileInput.value = '';
		}
		
		function removeFile(index) {
			selectedFiles.splice(index, 1);
			renderFilePreviews();
		}
		
		function handleEnter(e) { if (e.key === 'Enter') { e.preventDefault(); handleInput(); } }
		
		function saveChatHistory() { localStorage.setItem('gemini_chat_history', JSON.stringify(chatHistory)); }
		
		const customAlert = document.getElementById('custom-alert');

		function resetKey() {
			customAlert.classList.remove('hidden');
		}

		function closeCustomAlert() {
			customAlert.classList.add('hidden');
		}

		function confirmReset() {
			localStorage.clear();
			location.reload();
		}

		customAlert.addEventListener('click', (e) => {
			if (e.target === customAlert) {
				closeCustomAlert();
			}
		});
		
		function handleInput() {
			if (isGenerating) { stopGeneration(); } else {
				const text = userInput.value.trim();
				const apiKey = localStorage.getItem('gemini_api_key');
				if (!text && selectedFiles.length === 0) return;
				if (!apiKey) saveApiKey(text);
				else sendMessage(text, apiKey);
			}
		}
		
		function stopGeneration() { if (abortController) abortController.abort(); }
		
		function updateUIState(generating) {
			isGenerating = generating;
			actionIcon.className = generating ? "fa-solid fa-square text-white text-xs" : "fa-solid fa-arrow-right text-xl";
		}
		
		function saveApiKey(keyText) {
			if (keyText.length < 10) { alert("API Key tidak valid."); return; }
			localStorage.setItem('gemini_api_key', keyText);
			userInput.value = '';
			userInput.placeholder = "Ketik pesan...";
			resetBtn.classList.remove('hidden');
			addMessageToUI('user', 'API Key dimasukkan.', false);
			setTimeout(() => {
				const msg = "**API Key tersimpan!** âœ…\n\nSilakan mulai chat.";
				addMessageToUI('model', msg, false);
				chatHistory = [{ role: "model", parts: [{ text: msg }] }];
				saveChatHistory();
			}, 600);
		}
		
		function addMessageToUI(role, text, isStream = false, files = []) {
			const div = document.createElement('div');
			const isUser = role === 'user';
			const uniqueId = 'msg-' + Date.now() + Math.random().toString(36).substr(2, 9);
			
			div.className = 'w-full max-w-3xl mx-auto mb-6';
			const fileGrid = generateFileGridHtml(files);
			
			let contentHtml = '';
			if (text) {
				if (isUser) {
					contentHtml = `<p class="whitespace-pre-wrap font-sans text-gray-700 font-normal">${text}</p>`;
				} else {
					try {
						contentHtml = isMarkedAvailable ? marked.parse(text) : `<p class="whitespace-pre-wrap">${text}</p>`;
					} catch (e) {
						contentHtml = `<p class="whitespace-pre-wrap">${text}</p>`;
					}
				}
			}
			
			const nameClass = isUser ? 'font-bold text-xs uppercase tracking-tight text-gray-500' : 'font-bold text-xs uppercase tracking-tight bg-gradient-to-r from-blue-600 to-cyan-400 bg-clip-text text-transparent';

			div.innerHTML = `
                <div class="w-full bg-gray-100 rounded-xl px-5 pt-3 pb-4">
                    <div class="flex items-center justify-between mb-1 pb-1 border-b border-gray-200">
                        <span class="${nameClass}">
                            ${isUser ? 'ANDA' : 'ASISTEN'}
                        </span>
                    </div>
                    ${fileGrid}
                    <div id="${uniqueId}" class="prose prose-sm max-w-none text-gray-700 font-normal leading-relaxed break-words">
                        ${contentHtml}
                    </div>
                </div>`;
			
			chatContainer.appendChild(div);
			setTimeout(() => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }), 50);
			return uniqueId;
		}
		
		function renderGroundingSources(elementId, metadata) {
			if (!metadata?.groundingAttributions?.length) return;
			const contentDiv = document.getElementById(elementId);
			if (!contentDiv) return;
			
			const wrapperDiv = contentDiv.closest('.w-full.bg-gray-100');
			const sourcesDiv = document.createElement('div');
			sourcesDiv.className = 'mt-3 pt-3 border-t border-gray-300 text-xs text-gray-600';
			
			let sourcesHtml = '<div class="flex items-center gap-2 mb-2 font-semibold text-gray-700"><i class="fa-brands fa-google"></i> Sumber Informasi:</div><div class="flex flex-wrap gap-2">';
			const seenUrls = new Set();
			metadata.groundingAttributions.forEach(source => {
				if (source.web?.uri && !seenUrls.has(source.web.uri)) {
					seenUrls.add(source.web.uri);
					sourcesHtml += `<a href="${source.web.uri}" target="_blank" class="flex items-center gap-1 bg-white px-2 py-1 rounded border border-gray-200 hover:border-blue-400 hover:text-blue-600 transition shadow-sm truncate max-w-[200px]" title="${source.web.title}"><span class="truncate">${source.web.title}</span><i class="fa-solid fa-external-link-alt text-[10px] opacity-50"></i></a>`;
				}
			});
			sourcesHtml += '</div>';
			sourcesDiv.innerHTML = sourcesHtml;
			wrapperDiv.appendChild(sourcesDiv);
		}
		
		function showLoadingPlaceholder() {
			const div = document.createElement('div');
			div.id = 'loading-indicator';
			div.className = 'w-full max-w-3xl mx-auto mb-6';
			div.innerHTML = `
                <div class="w-full bg-gray-100 rounded-xl px-5 pt-3 pb-4">
                    <div class="flex items-center justify-between mb-1 pb-1 border-b border-gray-200">
                        <span class="font-bold text-xs uppercase tracking-tight bg-gradient-to-r from-blue-600 to-cyan-400 bg-clip-text text-transparent">ASISTEN</span>
                    </div>
                    <div class="flex items-center gap-1 py-2">
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    </div>
                </div>`;
			chatContainer.appendChild(div);
			chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
		}
		
		function removeLoading() {
			const loader = document.getElementById('loading-indicator');
			if (loader) loader.remove();
		}
	</script>
</body>
</html>
